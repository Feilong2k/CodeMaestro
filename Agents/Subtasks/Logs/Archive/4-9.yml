# Subtask Log: 4-9 (Orchestrator Automation)
id: "4-9"
title: "Orchestrator Automation (Concern-Based Locking & Branching)"
status: in_progress
branch: "subtask/4-9-orchestrator-automation"

history:
  - ts: "2023-12-07T20:00:00Z"
    role: orchestrator
    action: CREATED
    message: "Log initialized for Orchestrator Automation. This phase implements the core logic for autonomous agent coordination."
  - ts: "2023-12-07T20:30:00Z"
    role: orchestrator
    action: NOTE_ADDED
    message: "Reprioritized to immediately follow 4-6 for foundational stability."
  - ts: "2025-12-07T11:10:00Z"
    role: orchestrator
    action: ASSIGNMENT
    message: "Assigned to Tara for Red Phase (Unit Tests). Goal: Define failing tests for Locking, Branching, Territory, and Protected Paths."
  - ts: "2025-12-07T11:15:00Z"
    role: tester
    action: TESTS_CREATED
    message: "Created unit tests for OrchestratorService covering Locking, Territory, Protected Paths, and Branching logic. Tests are failing (Red Phase)."
  - ts: "2025-12-07T11:20:00Z"
    role: orchestrator
    action: HANDOFF
    message: "Handoff to Devon for Green Phase (Implementation). Goal: Implement OrchestratorService to satisfy tests."
  - ts: "2025-12-07T11:35:00Z"
    role: orchestrator
    action: PLAN_UPDATE
    message: "Defined Architectural Blueprint and Developer Instructions for Devon."
  - ts: "2025-12-07T11:45:00Z"
    role: orchestrator
    action: REFINEMENT
    message: "Updated Branching Logic to support 'Factory Floor' model (Feature Branches per Concern)."
  - ts: "2025-12-07T12:00:00Z"
    role: orchestrator
    action: DECISION
    message: "Answered Devon's architectural questions: Use Singleton export, Merge with existing class, Use direct pool connection."
  - ts: "2025-12-07T05:38:00Z"
    role: devon
    action: IMPLEMENTATION_COMPLETE
    message: "Implemented OrchestratorService with concern-based locking, territory rules, protected paths, and branching logic. All unit tests pass (Green). Refactored code for clarity and performance."

# ==========================================
# DEVON INSTRUCTIONS (IMPLEMENTATION GUIDE)
# ==========================================
# Goal: Implement `OrchestratorService` to pass the tests in `backend/src/__tests__/unit/orchestratorService.test.js`.

implementation_plan:
  database_migration:
    file: "backend/src/db/migrations/010_create_locks_table.sql"
    sql: |
      CREATE TABLE IF NOT EXISTS locks (
        id SERIAL PRIMARY KEY,
        task_id VARCHAR(50) NOT NULL,
        concern VARCHAR(50) NOT NULL,
        agent_id VARCHAR(50) NOT NULL,
        locked_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
        UNIQUE(task_id, concern)
      );

  service_logic:
    file: "backend/src/services/orchestrator.js"
    export_style: "singleton" # module.exports = new OrchestratorService()
    imports:
      - "const { pool } = require('../db/connection');"
    
    methods:
      - name: "acquireLock(taskId, concern, agentId)"
        logic: |
          1. Try SELECT * FROM locks WHERE task_id = ? AND concern = ?
          2. If exists AND agent_id == requestor -> Return Success (Re-entrant)
          3. If exists AND agent_id != requestor -> Throw Error "Locked by {agent_id}"
          4. If not exists -> INSERT -> Return Success

      - name: "releaseLock(taskId, concern)"
        logic: |
          DELETE FROM locks WHERE task_id = ? AND concern = ?

      - name: "checkTerritory(agentId, concern, filePath)"
        logic: |
          - If agentId == 'tara' AND concern == 'tests':
             Allow: path.includes('__tests__') OR path == 'package.json'
             Block: Everything else
          - If agentId == 'devon' AND concern == 'implementation':
             Allow: path.startsWith('src/') AND !path.includes('__tests__')
             Block: Everything else
          - If agentId == 'orion': Allow All
          - Default: Block

      - name: "isProtectedPath(filePath)"
        logic: |
          Return TRUE if path matches:
          - .env
          - config/**/*
          - backend/src/db/migrations/**/*
          - Docs/Operational_Rules.md
          - Docs/env.contract.md
          - package.json (conditional)

      - name: "getBranchName(taskId, concern)"
        logic: |
          // Implements Factory Floor Model logic
          If concern == 'base' -> Return "subtask/${taskId}-base"
          Else -> Return "feature/${taskId}-${concern}"
          // Note: If tests call getConcernBranchName, alias it to this method.

requiredActions:
  - "DB: Create Migration `010_create_locks_table.sql`"
  - "Code: Implement `OrchestratorService` in `backend/src/services/orchestrator.js`"
  - "Verify: Run `npx jest src/__tests__/unit/orchestratorService.test.js`"

verificationChecklist:
  - "[x] [TDD] Failing Unit Tests created (Red)"
  - "[x] [TDD] Implementation satisfies Unit Tests (Green)"
  - "[x] [TDD] Refactor pass (Cleanup)"
  - "[ ] [TDD] Integration Tests - REQUIRED for this task"
  - "[ ] Concern-based locks prevent concurrent work on same concern/task"
  - "[ ] Agents are assigned based on role, status, and concern"
  - "[ ] Agents cannot write to protected paths without explicit approval/lock"
  - "[ ] Branch names follow Factory Floor convention"

dependencies: ["4-6"]

resolvedQuestions:
  - question: "Module export style?"
    answer: "Export a Singleton Instance: `module.exports = new OrchestratorService();`"
  - question: "Existing class?"
    answer: "Merge/Overwrite. This is the definitive service."
  - question: "DB Connection?"
    answer: "Use `pool` directly from `db/connection`."
  - question: "getConcernBranchName vs getBranchName?"
    answer: "Implement `getBranchName(taskId, concern)`. If tests require, alias `getConcernBranchName` to it."

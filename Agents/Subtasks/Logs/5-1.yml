# Subtask Log: 5-1 (Tool Registry & Safety - Core)
id: "5-1"
title: "Tool Registry & Safety (Core)"
status: completed
branch: "subtask/5-1-tool-registry-core"

constraint_discovery:
  subtask_id: "5-1"
  owner: "Orion"
  concern: "Safety"
  date: "2025-12-08"

  atomic_actions:
    - action: "Create Tool Registry"
      description: "Central dictionary of allowed tools per agent role"
    - action: "Implement FileSystem Tools"
      description: "Safe wrappers for fs operations (read/write/list)"
    - action: "Implement Git Tools"
      description: "Safe wrappers for git operations"
    - action: "Implement Database Tools"
      description: "Safe wrappers for DB operations (Orion only)"

  resources_touched:
    - resource: "ToolRegistry"
      constraint: "Must be extensible but secure"
    - resource: "FileSystem"
      constraint: "Path traversal protection"

  resource_physics:
    - resource: "Agent Capabilities"
      constraint: "Role-based restriction"
      risk: "Agents using tools they shouldn't (e.g., Devon modifying DB directly)"
    - resource: "Data Loss Prevention"
      constraint: "Overwrite Protection"
      risk: "Agent overwrites entire file when meaning to update it"
      mitigation: "FileTool.write fails if exists (unless overwrite=true). DBTool blocks DROP/TRUNCATE."

  verification:
    - action: "Unit Tests"
      method: "Verify tool instantiation and permission checks"

implementation_plan:
  - component: "ToolRegistry"
    path: "backend/src/tools/registry.js"
    details: |
      - Exports `getToolsForRole(role)` function.
      - Maps roles (Devon, Tara, Orion) to allowed tool definitions.
      - Tool definition includes `name`, `description`, `parameters`, `handler`.

  - component: "FileSystemTool"
    path: "backend/src/tools/FileSystemTool.js"
    details: |
      - `safeRead(path)`: Checks if path is within project root.
      - `safeWrite(path, content, options)`: 
          - **Logic Gate:** If file exists and `!options.overwrite`, THROW ERROR.
          - Checks path, ensures directory exists.
      - `safeList(path)`: Lists directory contents.
      - Usage of `path.resolve` and `process.cwd()` for safety.

  - component: "GitTool"
    path: "backend/src/tools/GitTool.js"
    details: |
      - Wraps `simple-git` or controlled `child_process.exec`.
      - Methods: `status()`, `add(files)`, `commit(message)`, `push()`, `checkout(branch)`.
      - Enforces whitelist of args (e.g., no `; rm -rf`).

  - component: "DatabaseTool"
    path: "backend/src/tools/DatabaseTool.js"
    details: |
      - **Restricted to Orion.**
      - `savePattern(pattern)`: Inserts into patterns table.
      - `updateWorkflow(name, definition)`: Updates workflow engine.
      - `searchLogs(query)`: Searches structured logs.
      - **Logic Gate:** Block `DROP`, `TRUNCATE` in raw query execution.

history:
  - ts: "2025-12-08T00:00:00Z"
    role: orchestrator
    action: CREATED
    message: "Log initialized. Splitting Phase 5-1 into manageable chunks. This log focuses on the Core Registry and File/Git/DB tools."
  - ts: "2025-12-08T00:05:00Z"
    role: system
    action: CHECKLIST_UPDATE
    message: "Added TDD verification checklist."
  - ts: "2025-12-08T00:06:00Z"
    role: orchestrator
    action: STARTED
    message: "Tara initialized for Red Phase (Tests)."
  - ts: "2025-12-08T00:45:00Z"
    role: system
    action: TEST_COMPLETE
    message: "Tara completed Red Phase (Unit Tests)."
  - ts: "2025-12-08T01:00:00Z"
    role: orchestrator
    action: UPDATED
    message: "Added Overwrite Protection logic gate requirements."
  - ts: "2025-12-08T09:00:00Z"
    role: system
    action: IMPLEMENTATION_COMPLETE
    message: "Devon completed Green Phase (Implementation)."
  - ts: "2025-12-08T09:05:00Z"
    role: orchestrator
    action: VERIFIED
    message: "Orion verified implementation. All tests passed."

requiredActions:
  - "[x] [TDD] Create failing unit tests (Red)"
  - "[x] [TDD] Implement core logic to pass tests (Green)"
  - "[x] [TDD] Refactor and clean up (Refactor)"
  - "[x] Create `backend/src/tools/registry.js` (The Manifest)"
  - "[x] Implement `backend/src/tools/FileSystemTool.js` (read/write/list with path safety + overwrite guard)"
  - "[x] Implement `backend/src/tools/GitTool.js` (status/add/commit/push/checkout)"
  - "[x] Implement `backend/src/tools/DatabaseTool.js` (Orion Only: savePattern, updateWorkflow, searchLogs + destructive guard)"
  - "[x] Define `RoleCapabilities` map (Who can use what)"

verificationChecklist:
  - "[x] [TDD] Failing Unit Tests created (Red)"
  - "[x] [TDD] Implementation satisfies Unit Tests (Green)"
  - "[x] [TDD] Refactor pass (Cleanup)"
  - "[x] [TDD] Integration Tests - REQUIRED for this task"
  - "[x] Coverage > 80%"
  - "[x] [TDD] ToolRegistry returns correct tools for 'Devon', 'Tara', 'Orion'"
  - "[x] [TDD] FileSystemTool throws error for path traversal ('../')"
  - "[x] [TDD] FileSystemTool throws error if overwriting existing file without flag"
  - "[x] [TDD] GitTool allows whitelisted commands (status, add, commit)"
  - "[x] [TDD] GitTool blocks dangerous args (e.g., rm -rf)"
  - "[x] [TDD] DatabaseTool throws error if role is not 'Orion'"

whitelists:
  commands:
    - "git status"
    - "git add"
    - "git commit"
    - "git push"
    - "git checkout"
    - "git branch"
    - "npm test"
    - "npm install"
    - "ls"
    - "dir"
    - "mkdir"
    - "grep"
    - "find"
    - "cp"
    - "mv"
    - "rm"
    - "ps"

blocklists:
  commands:
    - "rm -rf /"
    - "sudo"
    - "chmod"
    - "chown"
    - "ssh"
    - "ftp"
    - "curl"
    - "wget"
    - "&&"

special_features:
  orion_override:
    description: "Orion can grant one-time tokens for non-whitelisted commands if deemed safe."
    mechanism: "Token-based grant system."
  auto_splitter:
    description: "ShellTool automatically detects '&&' and executes commands sequentially."
    constraint: "Must maintain cwd context between split commands."

# Subtask Log: 6-1 (Agent FSM Core + DB Logging)
id: "6-1"
title: "Agent FSM Core + DB Logging"
status: pending
branch: "subtask/6-1-agent-fsm-core-db"

phase: 6
owner: "Devon"
priority: critical

description: |
  Implement the core Agent Finite State Machine (FSM) for OBSERVE–THINK–ACT–WAIT–
  VERIFY–COMPLETE–ERROR, and log every state transition into the database. This 
  makes the agent loop visible and auditable.

constraint_discovery:
  subtask_id: "6-1"
  owner: "Orion"
  concern: "Process Transparency & Traceability"
  date: "2025-12-09"

  atomic_actions:
    - action: "Design AgentFSM states and transitions"
      description: "Define valid state transitions and error handling paths."
    - action: "Implement AgentFSM as pure logic"
      description: "Create a testable module with no external side effects."
    - action: "Wire AgentExecutor to use AgentFSM"
      description: "Drive agent runs through FSM instead of ad-hoc loops."
    - action: "Log transitions to DB"
      description: "Record from_state, to_state, agent, and subtask_id for each step."

  resources_touched:
    - resource: "AgentExecutor"
      constraint: "Must not break existing basic behavior while refactoring."
    - resource: "Database (Postgres)"
      constraint: "New table must be efficient and non-blocking for writes."

  resource_physics:
    - resource: "Long-Running Tasks"
      constraint: "FSM may run many steps per task."
      risk: "Logging every step could bloat the DB."
      mitigation: "Keep log rows compact; allow pruning by subtask_id or age."

    - resource: "LLM Non-Determinism"
      constraint: "LLM outputs may be inconsistent across runs."
      risk: "Harder to reproduce issues without logs."
      mitigation: "Include enough metadata in logs to replay or analyze behavior."

  verification:
    - action: "FSM Unit Tests"
      method: "Pure tests over AgentFSM ensure all transitions and errors behave as expected."
    - action: "Integration Tests"
      method: "Run a simple task and assert that a sequence of DB log rows matches expected transitions."

implementation_plan:
  - component: "AgentFSM Module"
    path: "backend/src/machines/AgentFSM.js"
    details: |
      - Implement a state machine with states:
        OBSERVE, THINK, ACT, WAIT, VERIFY, COMPLETE, ERROR.
      - Provide pure transition functions that accept a context and return next state + updated context.
      - No direct I/O in this module (for ease of testing).

  - component: "AgentExecutor Integration"
    path: "backend/src/services/AgentExecutor.js"
    details: |
      - Replace existing while-loop with calls into AgentFSM.
      - At each step, update context (e.g., lastResult, stepCount, subtaskId).
      - Trigger side effects (LLM calls, tool calls) based on FSM decisions.

  - component: "FSM Transition Logging (DB)"
    path: "backend/src/services/AgentFsmLogService.js" (new)
    details: |
      - Create a service that writes to a new table `agent_fsm_log`.
      - Columns: id, subtask_id, agent, from_state, to_state, timestamp.
      - Provide a query function for logs by subtaskId.

  - component: "API Endpoint for FSM Logs"
    path: "backend/src/routes/agents.js" or new route
    details: |
      - Add GET `/api/agent-fsm-log/:subtaskId`.
      - Return chronological list of transitions for the given subtask.

  - component: "SystemLogPanel Integration (Read-Only)"
    path: "frontend/src/components/SystemLogPanel.vue" / store
    details: |
      - When viewing a subtask, fetch `/api/agent-fsm-log/:subtaskId` once.
      - Display a simple list of state changes (e.g., "Orion: OBSERVE → THINK").

requiredActions:
  - "[x] [TDD] Create failing unit tests for AgentFSM (Red)"
  - "[x] [TDD] Implement AgentFSM state logic to satisfy tests (Green)"
  - "[x] [TDD] Wire AgentExecutor to AgentFSM and update tests"
  - "[x] [TDD] Add AgentFsmLogService and DB migration for agent_fsm_log table"
  - "[x] [TDD] Add API endpoint and integration tests for /api/agent-fsm-log/:subtaskId"
  - "[ ] [Coverage] Add tests for AgentFSM updateContext branches (ERROR_HANDLED, VERIFICATION_FAILED increments) and AgentFsmLogService error handling to raise statements/lines > 80%"

agentInstructions:
  devon:
    summary: |
      Implement and wire the AgentFSM and logging stack to satisfy Tara's tests
      without touching test files. All work must stay within backend/src/** and
      related migration/route files.
    steps:
      - "Implement AgentFSM module in backend/src/machines/AgentFSM.js as pure logic (no I/O)."
      - "Refactor backend/src/services/AgentExecutor.js to drive the loop via AgentFSM but keep existing behavior backward-compatible."
      - "Implement AgentFsmLogService and DB migration 022_create_agent_fsm_log.sql so each state transition is logged (from_state, to_state, subtask_id, agent, timestamp)."
      - "Add /api/agent-fsm-log/:subtaskId endpoint and wire route in backend/index.js so logs are queryable."
      - "Run backend tests locally and ensure all 6-1-related tests pass before pushing feature/6-1-agent-fsm-core-db."

  tara:
    summary: |
      Own all tests for AgentFSM and logging behavior, strictly in backend/__tests__/**.
      Do not modify backend/src/** implementation files.
    steps:
      - "Extend backend/__tests__/unit/agentFsm.test.js to cover all valid and invalid FSM transitions (OBSERVE→THINK, THINK→ACT, error states, etc.)."
      - "Add or extend integration tests that run a simple agent task and assert that multiple rows are written to agent_fsm_log for a known subtask_id."
      - "Add tests that hit /api/agent-fsm-log/:subtaskId and assert the returned sequence matches the DB order."
      - "Coordinate with 6-10 so that once SystemLogPanel is wired, you can later verify that System Log shows the same transitions as the DB and API."

verificationChecklist:
  - "[x] [TDD] Failing Unit Tests created (Red)"
  - "[x] [TDD] Implementation satisfies Unit Tests (Green)"
  - "[x] [TDD] Refactor pass (Cleanup)"
  - "[ ] [TDD] Integration Tests"
  - "[ ] [TDD] Final test by Tara and Coverage > 80%"
  - "[x] FSM unit tests cover all valid and invalid transitions"
  - "[ ] Running a simple agent task creates multiple rows in agent_fsm_log"
  - "[x] /api/agent-fsm-log/:subtaskId returns the same sequence as seen in DB"
  - "[ ] SystemLogPanel displays a readable list of state changes"

coveragePlan:
  targets:
    - file: "backend/src/machines/AgentFSM.js"
      focus: ["updateContext branches: ERROR_HANDLED, VERIFICATION_FAILED, step counters"]
    - file: "backend/src/services/AgentFsmLogService.js"
      focus: ["error handling paths, DB write failures"]
  suggestedCommands:
    - "cd c:\\Coding\\CM\\backend; npx jest --coverage --collectCoverageFrom \"src/machines/AgentFSM.js\" \"src/services/AgentFsmLogService.js\" -- src/__tests__/unit/agentFsm.test.js"
  notes:
    - "Tara adds tests only under backend/__tests__/**; Devon must not touch tests."
    - "Aim for >80% statements and lines across the two modules; functions/branches follow as feasible."

human_verification:
  - "Run a small agent task for a known subtask ID (for example, ask Orion to plan for subtask 5-9)."
  - "Use a simple DB viewer or script to run: SELECT * FROM agent_fsm_log WHERE subtask_id = '5-9';"
  - "Confirm you see multiple rows, each showing from_state and to_state for Orion or another agent."
  - "In the web app, open the System Log view for that subtask and check that you see matching messages like 'Orion: OBSERVE → THINK', 'Orion: THINK → ACT', etc."

history:
  - ts: "2025-12-09T00:40:00Z"
    role: orchestrator
    action: CREATED
    message: "Initialized v2.2 subtask for Agent FSM core and DB logging (Task 6-1)."
  - ts: "2025-12-09T15:34:00Z"
    role: tester
    action: TESTS_CREATED
    message: "Created failing unit tests for AgentFSM (Red phase)."
  - ts: "2025-12-09T17:15:00Z"
    role: devon
    action: IMPLEMENTED
    message: "Implemented AgentFSM core, wired AgentExecutor, added AgentFsmLogService and DB migration, and API endpoint. All unit tests pass."

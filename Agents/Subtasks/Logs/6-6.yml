# Subtask Log: 6-6 (State Machine Action Hooks & Automated Orchestration)
id: "6-6"
title: "State Machine Action Hooks & Automated Orchestration"
status: pending
branch: "subtask/6-6-orchestrator-automation"

phase: 6
owner: "Devon"
priority: critical

description: |
  Activate the existing subtask TDD state machine and OrchestratorService so that
  subtask state transitions automatically trigger concrete orchestration actions.
  
  Today, the xstate machine and OrchestratorService track subtask status, but
  they do not actually perform the git, manifest, and notification work that
  you are doing manually as Orion. This task closes that gap and makes
  orchestration truly automatic.

  Web-app / system priority: when a subtask moves from RED → GREEN → REFACTOR →
  INTEGRATION → VERIFICATION → COMPLETE, the system should:
    - Enforce the correct next actor (Tara vs Devon vs Orion)
    - Run the right git operations (branch creation, merge, push)
    - Update the manifest/logs as the source of truth
    - Emit events for the UI (SystemLogPanel, ActivityLog)

constraint_discovery:
  subtask_id: "6-6"
  owner: "Orion"
  concern: "Automated Orchestration & Process Discipline"
  date: "2025-12-09"

  atomic_actions:
    - action: "Map states to orchestration actions"
      description: "Define, for each subtaskMachine state, what concrete actions Orion should perform (e.g., merge test branch, assign implementation)."
    - action: "Add state-action hooks to OrchestratorService"
      description: "Extend OrchestratorService.transition to call an action executor when state changes."
    - action: "Extend GitTool for orchestration workflows"
      description: "Add safe merge/fetch/pull helpers used by automation (no ad-hoc shell git)."
    - action: "Integrate manifest updates with state changes"
      description: "Automatically update Agents/Subtasks/manifest.yml based on subtask state."
    - action: "Emit orchestration events for UI"
      description: "Emit WebSocket events so SystemLogPanel and ActivityLog show who did what, and when."

  resources_touched:
    - resource: "OrchestratorService"
      constraint: "Must remain backwards-compatible and not break existing manual flows."
    - resource: "GitTool"
      constraint: "New operations must be safe, validated, and respect RBAC/role rules."
    - resource: "Agents/Subtasks manifest & logs"
      constraint: "Automation must preserve human readability and not corrupt YAML."

  resource_physics:
    - resource: "Git & Branch State"
      constraint: "Branches can be out-of-date or missing locally."
      risk: "Automated merges may fail or create conflicts without clear visibility."
      mitigation: "Use safe fetch/merge patterns; log all failures to SystemLogPanel and avoid auto-resolving conflicts."

    - resource: "Human Override"
      constraint: "Orion must retain the ability to pause or override automation."
      risk: "Runaway automation could perform merges when not desired."
      mitigation: "Introduce a config flag / mode (manual vs assisted vs full-auto) and log all decisions."

  verification:
    - action: "Unit tests for state→action mapping"
      method: "Pure tests that given (oldState, newState, metadata) assert the correct orchestration plan is produced."
    - action: "Integration tests for OrchestratorService.transition"
      method: "Simulate key transitions (e.g., RED→GREEN) and assert that GitTool and manifest updates are called as expected."
    - action: "End-to-end test using a Phase 6 subtask (e.g., 6-0)"
      method: "Drive the subtask through states and verify that branches are created/merged and manifest/logs are updated."

implementation_plan:
  - component: "State→Action Mapping Table"
    path: "backend/src/services/orchestration/stateActionMap.js"
    details: |
      - Export a pure function `planActions({ subtaskId, previousState, newState, metadata })`.
      - Return a list of high-level actions, e.g.:
        - `[{ type: 'merge_tests', branch: 'feature/6-0-tests', target: 'phase-6-base' }, ...]`
      - Cover common flows:
        - pending → in_progress
        - in_progress → red
        - red → green (tests passing)
        - green → refactor
        - refactor → integration_red / integration_green
        - integration_green → verification
        - verification → completed
      - Example intent → tool_call sketch (for natural language "read and summarize Docs/Phase6_Plan.md"):
        - IntentParser detects `intent: read_file_and_summarize` and `filePath: Docs/Phase6_Plan.md`.
        - OBSERVE/THINK passes this metadata into the FSM transition.
        - stateActionMap returns a `tool_call` action using FileSystemTool.read with the given path.
        - OrchestratorService.transition passes the plan to OrchestrationExecutor.
        - OrchestrationExecutor calls BodyInterface.executeTool('FileSystemTool', 'read', { path }),
          and the next THINK step summarizes the file content for the user.

  - component: "OrchestratorService Hooks"
    path: "backend/src/services/orchestrator.js"
    details: |
      - Extend `transition(subtaskId, event, eventData)` to:
        - Capture `previousState` and `newState`.
        - Call `planActions` with subtaskId + states + metadata.
        - Pass the resulting plan to an `OrchestrationExecutor`.
      - Ensure errors in orchestration do **not** corrupt the subtask state; they should surface as separate errors.

  - component: "OrchestrationExecutor"
    path: "backend/src/services/orchestration/OrchestrationExecutor.js"
    details: |
      - Consume action plans and perform concrete operations:
        - Call GitTool for fetch/merge/checkout as needed.
        - Update manifest.yml via a ManifestService (if available) or a safe file-edit layer.
        - Emit WebSocket events to notify agents/users (e.g., `orchestration_action_performed`).
      - Implement idempotency where possible (e.g., merging an already-merged branch should be a no-op).

  - component: "GitTool Extensions for Orchestration"
    path: "backend/src/tools/GitTool.js"
    details: |
      - Add safe helpers:
        - `merge({ source, target })`
        - `fetch({ remote, branch })`
        - `checkout({ branch, createFrom })`
      - Reuse existing validation and exec wrapper.
      - Ensure operations are logged and errors are propagated clearly.

  - component: "Event Emission for UI"
    path: "backend/src/socket/index.js" and/or new orchestration events module
    details: |
      - Emit events like `orchestration_plan_created` and `orchestration_action_performed`.
      - Payload should include: subtaskId, actions, outcome, error (if any).
      - SystemLogPanel and ActivityLog can subscribe later (6-0/6-8).

requiredActions:
  - "[ ] [TDD] Create failing unit tests for state→action mapping (Red)"
  - "[ ] [TDD] Implement stateActionMap to satisfy tests (Green)"
  - "[ ] [TDD] Add OrchestratorService hooks to call stateActionMap + OrchestrationExecutor"
  - "[ ] [TDD] Extend GitTool with merge/fetch/checkout helpers and add tests"
  - "[ ] [TDD] Add integration tests simulating 6-0 and 6-1 flows"

verificationChecklist:
  - "[ ] [TDD] Failing Unit Tests created (Red)"
  - "[ ] [TDD] Implementation satisfies Unit Tests (Green)"
  - "[ ] [TDD] Refactor pass (Cleanup)"
  - "[ ] [TDD] Integration Tests"
  - "[ ] [TDD] Final test by Tara and Coverage > 80%"
  - "[ ] RED→GREEN on 6-0 automatically produces a merge plan for Tara's test branch into phase-6-base"
  - "[ ] GREEN→REFACTOR on 6-1 does **not** trigger a merge, but may update assignment/notifications only"
  - "[ ] COMPLETED on a subtask triggers a plan to mark it completed in manifest.yml (no direct merge to master)"
  - "[ ] All orchestration actions are visible in SystemLogPanel/ActivityLog via emitted events (once UI wiring exists)"

human_verification:
  - "Pick an in-progress Phase 6 subtask (e.g., 6-0 once tests exist)."
  - "Drive its state from RED → GREEN using the OrchestratorService API or CLI helper."
  - "Verify that without manually running git commands, the correct feature branch is merged into phase-6-base (or a dry-run plan is logged, depending on mode)."
  - "Open the manifest and logs to confirm that the subtask status and history have been updated to reflect the new state and orchestration actions."

history:
  - ts: "2025-12-09T11:00:00Z"
    role: orchestrator
    action: CREATED
    message: "Initialized subtask for activating state machine-driven orchestration (6-6)."

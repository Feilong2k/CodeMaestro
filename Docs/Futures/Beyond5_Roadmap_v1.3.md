# Beyond5 Roadmap v1.3 (Phase 6)

## Overview
This roadmap outlines the evolution of Orion’s architecture and capabilities beyond Phase 5, focusing on three sequential milestones:

1. **Two‑Tiered Consultative Brain** – Replace the current split‑brain routing with a unified first‑level brain that can consult a second‑level specialist for architectural decisions via a manifest‑driven workflow.
2. **Critical Tool Improvements & Enhanced UX** – Equip the first‑level brain with the tool‑calling fluency of Cline/Cursor and add a tabbed UI panel for real‑time reasoning visibility and document interaction.
3. **Body Awareness** – Implement system‑level health checks, monitoring, and resilience features.

Each milestone builds on the previous one, ensuring foundational changes are stable before adding complexity.

---

## Milestones

### Milestone 1: Two‑Tiered Brain Structure (Weeks 1‑2)
**Goal**: Deliver a unified chat experience where Orion understands natural‑language requests directly, can self‑diagnose uncertainty, and consults a specialist only when needed.

**Deliverables**:
1. `UnifiedAdapter` – A single LLM adapter using DeepSeek‑Chat (fast, cost‑effective) with function‑calling for all tools, **outputting JSON reasoning** (thoughts, actions, parameters) for full visibility.  
   *Second‑tier consultant*: DeepSeek‑Reasoner (or Gemini‑3/GPT‑4) for architectural analysis.
2. **First‑Brain Prompt** – Comprehensive prompt with:
   - Identity & core instructions.
   - Project context (directory tree, key config files).
   - **Tool guide** – each tool described with when‑to‑use scenarios and concrete examples.
   - Examples of clarification questions generated by the first brain itself.
3. **Dynamic Context Sliding Window** – The adapter manages token usage by keeping static prompt parts (identity, tool definitions) and dynamically including only relevant file snippets and recent conversation turns. When the agent needs more context, it proactively uses `FileSystemTool.read` to fetch additional files.
4. **Confidence‑Driven Clarification Loop**:
   - Lightweight router (embedding‑based or `gpt‑4o‑mini`) classifies intent (`change` vs `design/refactor`) with a confidence score.
   - If confidence < 80%, the router prompts the first brain to generate a concise clarification question.
   - The question is presented to the user; the answer is used to re‑evaluate intent.
   - **UI streaming**: The first brain’s reasoning JSON is streamed immediately so the user sees progress while consultation proceeds.
5. **Manifest‑Driven Consultation**:
   - For high‑confidence design/refactor requests, the first brain creates a **manifest** with the following refined schema:
   ```json
   {
     "intent": "string",
     "escalation_reason": "string (why this needs architectural review)",
     "risk_assessment": "Low|Medium|High – brief rationale",
     "files": [
       { "path": "...", "operation": "read|write|delete", "purpose": "..." }
     ],
     "dependencies": [],
     "approach": "string",
     "context": {
       "relevantFileSnippets": ["..."],
       "conversationSummary": "string",
       "knownConstraints": []
     }
   }
   ```
   - The manifest is sent to the `StrategicConsultant` (second‑level brain) for advisory analysis.
   - The consultant returns a structured **advisory report** (constraints, gaps, conditions, recommendations) that is presented in the Orion’s Workspace tab.
   - **Two‑phase delivery**: The first brain can output a preliminary plan immediately while the consultation runs in the background; the advisory report is added as an update.
6. **Updated `OrionAgent.chat`** – Removes tactical/strategic routing heuristics; uses the new clarification loop, manifest flow, and JSON‑reasoning‑enabled `UnifiedAdapter`. Keeps a local fast‑path router for explicit commands (`list docs`, `read Docs/…`) that match simple regex patterns.

**Fallback Strategy**:
- If the first‑brain model (DeepSeek‑Chat) is unavailable → fallback to GPT‑4o with a simplified prompt.
- If the strategic consultant is unavailable → the first brain runs a lightweight, rule‑based CDP using hard‑coded best practices (no second‑tier call).

**Acceptance Criteria**:
- User can say “Refactor the chat panel to use virtual scrolling” and Orion automatically decomposes the task, outputs its reasoning as JSON, and optionally consults the specialist (presenting the advisory report).
- When a request is ambiguous (“Can you make a todo list?”), Orion asks a tailored clarification question.
- System Log shows JSON reasoning steps, clarification events, and consultation advisories.
- The first brain correctly uses tools based on the examples in the prompt (e.g., creates files, reads files, runs git commands).

### Milestone 2: Critical Tool Improvements & Enhanced UX (Weeks 3‑4)
**Goal**: Equip the first‑level brain with the tools that make Cline/Cursor so effective, and provide a rich UI for observing and interacting with Orion’s thought process.

**Deliverables**:
1. **Enhanced FileSystemTool** – Add:
   - `search(path, pattern, fileType?)` – uses `ripgrep` (`rg`) under the hood with file‑type filtering (e.g., `--type ts,vue`).
   - `fileTree(path, depth?)` – get a tree view of the directory structure.
   - `editFile(path, changes)` – **search‑and‑replace blocks** or **unified diffs** (preferred over line‑number‑based edits). After any edit, the tool automatically runs a dry‑run lint/type‑check; if syntax errors occur, it reverts and returns the error to the agent.
2. **Project‑Awareness Tool** – Reads `package.json`, `tsconfig.json`, `.gitignore` etc. to inform the LLM about project structure and dependencies.
3. **Multi‑Step Session Tool** – Maintains a goal stack (queue of subtasks) and tracks progress within a conversation (enables “now update the CSS too” without re‑explaining).
4. **Frontend Tabbed Panel** – Extend the existing UI (likely `StatusBar.vue`) with three tabs:
   - **Activity Log** – Current activity stream (what Orion is doing), including streaming shell‑command output.
   - **System Log** – Existing WebSocket events (infrastructure, errors).
   - **Orion’s Workspace** – A two‑way communication panel where:
     - *Thought Process*: Live feed of Orion’s JSON reasoning, formatted as a collapsible tree.
     - *Document Viewer*: Orion can push Markdown, text, or HTML documents (e.g., generated CDP results, manifests, architecture diagrams) and they are rendered here.
     - *User Interaction*: Users can expand/collapse sections, view documents, and provide feedback. Panels are resizable (using Vue’s `splitpanes` or CSS `resize`).
5. **New Tool `displayDocument`** – Allows Orion to send content to the Workspace tab (payload: `{ title, content, format }`).
6. **Enhanced Prompt** – Add layers for project‑awareness and multi‑step session guidance.
7. **Shell Output Streaming & Structured Errors (Task 6‑4)** – Stream shell‑command output in real time to the Activity Log and structure error messages for better debugging.
8. **Proprioception & Context Wiring (First Slice) (Task 6‑5)** – Wire internal agent states (OBSERVE/THINK/ACT) to the system log and health‑check service.

**Acceptance Criteria**:
- User can say “Find all uses of `useFocus` in the codebase” and Orion returns a list of files and lines (using the enhanced search).
- Orion knows the project is Vue 3 + TypeScript and tailors its suggestions accordingly.
- Complex refactors are handled as a single session with step‑by‑step progress tracked.
- The tabbed UI displays Orion’s real‑time reasoning and allows the user to view generated documents (e.g., a manifest or CDP report) inline.
- Shell‑command output streams live to the Activity Log.
- Agent state transitions are visible in the System Log.

### Milestone 3: Body Awareness (Weeks 5‑6)
**Goal**: Make Orion self‑monitoring and resilient.

**Deliverables**:
1. **Health‑Check Service** – Periodic validation of LLM API connectivity, database latency, disk space, and tool availability.
2. **System‑Log Dashboard** – Real‑time visualization of agent states, consultation calls, and constraint‑discovery findings (integrates with the new tabbed UI).
3. **Circuit‑Breaker Patterns** – Automatic fallback to mock modes or cached responses when external services are down.
   - First‑brain downtime → fallback to GPT‑4o (or another model).
   - Strategic‑consultant downtime → first brain runs rule‑based CDP.
4. **Performance Metrics** – Track response latency, tool‑call success rates, and consultation costs.

**Acceptance Criteria**:
- Orion logs a warning when DeepSeek‑Reasoner API latency exceeds 5 s.
- The dashboard shows a live stream of state transitions (`OBSERVE` → `THINK` → `ACT`).
- If the strategic consultant is unavailable, consultations gracefully degrade to a local rule‑based checklist.
- Weekly report of API usage, error rates, and user satisfaction (via implicit signals).

---

## Key Design Decisions (Incorporated from Planning Discussions)

### 1. **First‑Brain‑Generated Clarification**
- No hard‑coded clarification questions. When the router’s confidence is low, it asks the first brain “What single question could I ask to clarify the user’s intent?” and uses the generated question.
- The same mechanism works for “intent unclear” scenarios (router cannot decide between change/design).

### 2. **JSON Reasoning Output**
- Every thought, tool‑call decision, and parameter is output in a structured JSON array (`reasoning`), enabling full visibility into Orion’s cognitive process.
- This output is logged to the database and streamed to the frontend’s **Orion’s Workspace** tab.

### 3. **Manifest‑Driven Advisory Consultation**
- The first brain creates a manifest (not code) for complex requests.
- The second brain returns an **advisory report** (not a boolean), presenting constraints, gaps, and conditions. The final decision stays with the human (or the first brain after user input).

### 4. **Tool‑Guide in Prompt**
- The prompt includes concrete examples of tool usage, each showing the thought process, the tool call, and the rationale. Examples are language‑agnostic and cover common scenarios (create file, read file, git status, run tests, ask clarification).

### 5. **Interactive UI Panel**
- The new **Orion’s Workspace** tab serves as Orion’s “mouth to the world”—it displays his thoughts, generated documents, and allows the user to inspect them without cluttering the chat window.

---

## Constraint Discovery Protocol Analysis (Full v4)
*Note: This section is carried forward from v1.0 and has not been updated per the user’s request to skip the CDP portion in this revision.*

[The original CDP analysis from v1.0 is included here verbatim for reference.]

---

## Implications & Trade‑offs

| Decision | Trade‑off | Long‑term Implication |
|----------|-----------|------------------------|
| **Two‑Tiered Brain** | Higher latency per request vs. Single Brain. | Higher accuracy on complex tasks; reduced technical debt. |
| **JSON Reasoning** | Higher token consumption (cost) for outputting thoughts. | Essential for debugging agent behavior and user trust. |
| **Workspace UI** | Increased frontend complexity (Vue + WebSockets). | Moves product from “Chat” to “Platform”; enables multi‑modal interaction. |
| **Manifest Workflow** | Requires strict schema compliance from LLMs (can be flaky). | Standardizes architectural reviews; creates a paper trail for decisions. |
| **Edit‑Tool Safety Rails** | Extra validation steps increase tool‑call latency. | Prevents codebase corruption; reduces user frustration. |
| **Dynamic Context Sliding Window** | More tool calls to fetch additional context. | Keeps token costs manageable; mimics IDE‑like navigation. |

---

*Document generated by Adam (Architect) on 2025‑12‑10. Last updated: 2025‑12‑10 (v1.3).*
